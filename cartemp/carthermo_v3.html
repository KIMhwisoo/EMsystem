<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸš— ì°¨ëŸ‰ ì˜¨ë„ ëª¨ë‹ˆí„° (WebApp v3)</title>
<style>
  :root { --bg:#0f1115; --card:#161a22; --fg:#e7edf3; --muted:#98a2b3; --accent:#3b82f6; --danger:#ef4444; --warn:#f59e0b; --ok:#10b981; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;}
  .wrap{max-width:820px; margin:24px auto; padding:16px}
  .card{background:var(--card); border:1px solid #232938; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
  h1{font-size:20px; margin:0 0 8px}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1 1 220px}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input[type="number"], input[type="text"]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a3142; background:#0d1119; color:var(--fg)}
  .btn{appearance:none; border:1px solid #2a3142; background:#0d1119; color:var(--fg); padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn.primary{background:var(--accent); border-color:var(--accent); color:white}
  .btn.ghost{background:transparent}
  .stat{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-radius:12px; background:#0d1119; border:1px solid #2a3142}
  .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #2a3142}
  .badge.ok{background:rgba(16,185,129,.1); border-color:rgba(16,185,129,.35); color:var(--ok)}
  .badge.warn{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:var(--warn)}
  .badge.danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:var(--danger)}
  canvas{width:100%; height:200px; background:#0d1119; border:1px solid #2a3142; border-radius:12px}
  .muted{color:var(--muted); font-size:13px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:560px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸš— ì°¨ëŸ‰ ì˜¨ë„ ëª¨ë‹ˆí„° (WebApp v3)</h1>
      <div class="row">
        <div class="col">
          <label>ì„œë²„ ì£¼ì†Œ (Processing ë¸Œë¦¿ì§€ ì„œë²„)</label>
          <input id="server" type="text" value="http://127.0.0.1:5200" />
          <div class="muted">ì˜ˆ) <code>http://PC_IP:5200</code> â€” í°ê³¼ PCëŠ” ê°™ì€ Wiâ€‘Fiì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</div>
        </div>
        <div class="col" style="align-self:end;">
          <button class="btn" id="saveServer">ì ìš©</button>
          <button class="btn ghost" id="ping">í•‘</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stat">
        <div>
          <div class="muted">í˜„ì¬ ì˜¨ë„</div>
          <div style="font-size:28px; font-weight:700;"><span id="curTemp">-</span> Â°C</div>
        </div>
        <div><span id="statusBadge" class="badge">ëŒ€ê¸°</span></div>
      </div>
      <div style="margin-top:12px">
        <canvas id="plot" width="700" height="200"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>ê³ ì˜¨ ì„ê³„ (HI, Â°C)</label>
          <input id="tHi" type="number" step="0.1" value="40" />
        </div>
        <div>
          <label>ì €ì˜¨ ì„ê³„ (LO, Â°C)</label>
          <input id="tLo" type="number" step="0.1" value="0" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="col">
          <label>ì‚¬ì¼ëŸ°íŠ¸ (ë¶€ì € ë”)</label>
          <input id="silent" type="text" value="false" />
          <div class="muted">true / false ì¤‘ íƒ1</div>
        </div>
        <div class="col" style="align-self:end;">
          <button class="btn primary" id="sendCfg">ì„¤ì • ë³´ë‚´ê¸°</button>
          <button class="btn" id="refreshCfg">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted">ì—°ê²°/ì˜¤ë¥˜ ë¡œê·¸</div>
      <pre id="log" style="white-space:pre-wrap; background:#0d1119; padding:10px; border:1px solid #2a3142; border-radius:12px; max-height:220px; overflow:auto;"></pre>
    </div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const serverInput = $('#server');
  const curTemp = $('#curTemp');
  const badge = $('#statusBadge');
  const log = $('#log');
  const tHi = $('#tHi');
  const tLo = $('#tLo');
  const silent = $('#silent');

  const plot = document.getElementById('plot');
  const ctx = plot.getContext('2d');
  const MAX_POINTS = 120;

  let points = [];

  const saved = localStorage.getItem('carthermo_server');
  if (saved) serverInput.value = saved;

  function setBadge(ok, warn=false){
    badge.className = 'badge ' + (ok ? (warn ? 'warn' : 'ok') : 'danger');
    badge.textContent = ok ? (warn ? 'ì£¼ì˜' : 'ì •ìƒ') : 'ì˜¤ë¥˜';
  }

  function addLog(s){
    const ts = new Date().toLocaleTimeString();
    log.textContent = `[${ts}] ${s}
` + log.textContent;
  }

  function n(v){
    const x = Number(v);
    return Number.isFinite(x) ? x : null;
  }

  function draw(){
    ctx.clearRect(0,0,plot.width,plot.height);
    ctx.strokeStyle = '#2a3142';
    ctx.strokeRect(8,8,plot.width-16,plot.height-16);

    if (points.length < 2) return;
    const minT = Math.min(...points.map(p=>p.t));
    const maxT = Math.max(...points.map(p=>p.t));
    const lo = Math.floor(Math.min(minT, n(tLo.value) ?? 0) - 2);
    const hi = Math.ceil(Math.max(maxT, n(tHi.value) ?? 40) + 2);

    ctx.strokeStyle = '#1f2533';
    ctx.lineWidth = 1;
    for (let y=0; y<=4; y++){
      const py = 8 + (plot.height-16)*y/4;
      ctx.beginPath(); ctx.moveTo(8, py); ctx.lineTo(plot.width-8, py); ctx.stroke();
    }

    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<points.length;i++){
      const x = 8 + (plot.width-16) * (i/(MAX_POINTS-1));
      const norm = (points[i].t - lo) / (hi - lo);
      const y = (plot.height-8) - norm*(plot.height-16);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    const hiN = ((n(tHi.value) ?? 40)-lo)/(hi-lo);
    const loN = ((n(tLo.value) ?? 0)-lo)/(hi-lo);
    const yHi = (plot.height-8) - hiN*(plot.height-16);
    const yLo = (plot.height-8) - loN*(plot.height-16);

    ctx.setLineDash([6,6]);
    ctx.strokeStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(8,yHi); ctx.lineTo(plot.width-8,yHi); ctx.stroke();
    ctx.strokeStyle = '#f59e0b'; ctx.beginPath(); ctx.moveTo(8,yLo); ctx.lineTo(plot.width-8,yLo); ctx.stroke();
    ctx.setLineDash([]);
  }

  async function fetchLatest(){
    try{
      const url = serverInput.value.replace(/\/$/,'') + '/api/latest';
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(res.status+'');
      const data = await res.json();

      const t = (data?.latest?.t ?? null);
      if (t == null){
        setBadge(false);
        addLog('latest ë°ì´í„° ì—†ìŒ');
        return;
      }

      curTemp.textContent = Number(t).toFixed(1);
      const hi = n(tHi.value) ?? 40;
      const lo = n(tLo.value) ?? 0;
      const warn = (t >= hi) || (t <= lo);
      setBadge(true, warn);

      points.push({t:Number(t), time:Date.now()});
      if (points.length > MAX_POINTS) points.shift();
      draw();

      if (data?.cfg){
        if (document.activeElement !== tHi) tHi.value = data.cfg.t_hi ?? tHi.value;
        if (document.activeElement !== tLo) tLo.value = data.cfg.t_lo ?? tLo.value;
        if (document.activeElement !== silent) silent.value = String(!!data.cfg.silent);
      }
    }catch(err){
      setBadge(false);
      addLog('ì—ëŸ¬: ' + err.message);
    }
  }

  async function loadCfg(){
    try{
      const url = serverInput.value.replace(/\/$/,'') + '/api/cfg';
      const res = await fetch(url, {cache:'no-store'});
      const cfg = await res.json();
      tHi.value = cfg.t_hi ?? tHi.value;
      tLo.value = cfg.t_lo ?? tLo.value;
      silent.value = String(!!cfg.silent);
      addLog('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ' + JSON.stringify(cfg));
    }catch(err){
      addLog('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message);
    }
  }

  async function sendCfg(){
    try{
      const hi = n(tHi.value);
      const lo = n(tLo.value);
      if (hi === null || lo === null){
        addLog('ìˆ«ìë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (ì†Œìˆ˜ì ì€ .)');
        return;
      }
      const body = { t_hi: hi, t_lo: lo, silent: /^true$/i.test(silent.value.trim()) };
      const url = serverInput.value.replace(/\/$/,'') + '/api/update_cfg';
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const txt = await res.text();
      if (!res.ok) throw new Error(res.status+' '+txt);
      addLog('ì„¤ì • ì „ì†¡ ì„±ê³µ: ' + JSON.stringify(body) + ' / ì‘ë‹µ: ' + txt);
      await loadCfg(); // â¬… ìë™ ì¬ì¡°íšŒ
    }catch(err){
      addLog('ì„¤ì • ì „ì†¡ ì‹¤íŒ¨: ' + err.message);
    }
  }

  document.getElementById('saveServer').onclick = ()=>{
    localStorage.setItem('carthermo_server', serverInput.value.replace(/\/$/,''));
    addLog('ì„œë²„ ì£¼ì†Œ ì €ì¥');
  };
  document.getElementById('ping').onclick = ()=> fetchLatest();
  document.getElementById('sendCfg').onclick = ()=> sendCfg();
  document.getElementById('refreshCfg').onclick = ()=> loadCfg();

  setInterval(fetchLatest, 1000);
  loadCfg();
  draw();
})();
</script>
</body>
</html>
